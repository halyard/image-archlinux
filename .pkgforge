name 'image-archlinux'
org 'halyard'

source(
  type: 'git',
  path: '.'
)

build do
  new_image = File.join(releasedir, 'image')
  new_root = tmpdir(:mount)

  run "truncate --size 1G #{new_image}"
  run "mkfs.ext4 -F #{new_image}"
  run "mount #{new_image} #{new_root}"

  run "pacstrap -c -G #{new_root} base linux mkinitcpio"
  run "cp -R overlay/* #{new_root}/"
  run "arch-chroot #{new_root} pacman-key --init"
  run "arch-chroot #{new_root} pacman-key --populate"
  run "arch-chroot #{new_root} locale-gen"
  %w(srv/ftp srv/http).each do |x|
    run "rm -rf #{new_root}/#{x}"
  end

  run "umount #{new_root}"
end

package(
  type: 'file',
  artifacts: [
    {
      source: 'image',
      name: 'image'
    }
  ]
)

test do
  # TODO: add tests
end
