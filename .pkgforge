name 'image-archlinux'
org 'halyard'

source(
  type: 'git',
  path: '.'
)

build do
  new_image = File.join(releasedir, 'image')
  new_root = tmpdir(:mount)

  run "dd if=/dev/zero of=#{new_image} bs=1MB count=2048"
  run "mkfs.ext4 -F #{new_image}"
  FileUtils.mkdir_p new_root
  run "mount #{new_image} #{new_root}"

  run "pacstrap -c -G #{new_root} base"
  run "cp -R overlay/* #{new_root}/"
  run "arch-chroot #{new_root} pacman-key --init"
  run "arch-chroot #{new_root} pacman-key --populate"
  run "arch-chroot #{new_root} locale-gen"
  %w(etc/hosts etc/mtab etc/resolv.conf sys srv/ftp srv/http proc).each do |x|
    run "rm -rf #{new_root}/#{x}"
  end

  run "umount #{new_root}"
end

package(
  type: 'file',
  artifacts: [
    {
      source: 'image',
      name: 'image'
    }
  ]
)

test do
  # TODO: add tests
end
